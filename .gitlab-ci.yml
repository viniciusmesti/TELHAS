image: node:18

stages:
  - install
  - lint
  - test
  - build

variables:
  NODE_ENV: 'production'
  BACKEND_DIR: 'backend'
  FRONTEND_DIR: 'frontend'

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ${BACKEND_DIR}/node_modules
    - ${FRONTEND_DIR}/node_modules

install_dependencies:
  stage: install
  script:
    - cd $BACKEND_DIR && npm ci --include=dev
    - cd ../$FRONTEND_DIR && npm ci --include=dev
  artifacts:
    paths:
      - $BACKEND_DIR
      - $FRONTEND_DIR

lint_backend:
  stage: lint
  script:
    - cd $BACKEND_DIR && npm run lint

lint_frontend:
  stage: lint
  script:
    - cd $FRONTEND_DIR && npm run lint || echo "Frontend lint n√£o configurado ou falhou"

test_backend:
  stage: test
  script:
    - cd $BACKEND_DIR && npm run test

build_backend:
  stage: build
  script:
    - cd $BACKEND_DIR && npm run build
  artifacts:
    paths:
      - $BACKEND_DIR/dist

build_frontend:
  stage: build
  before_script:
    - apt-get update && apt-get install -y build-essential python3 g++ make && rm -rf /var/lib/apt/lists/*
  script:
    - cd $FRONTEND_DIR && npm rebuild && npm run build
  artifacts:
    paths:
      - $FRONTEND_DIR/.next
